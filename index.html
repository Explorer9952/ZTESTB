<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M3U Видеоплеер</title>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@1.0.0/dist/hls.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #1a1a1a;
            padding: 10px;
            color: #fff;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: #2d2d2d;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
        }
        
        header {
            padding: 15px 20px;
            background-color: #3498db;
            text-align: center;
        }
        
        h1 {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }
        
        .main-content {
            display: flex;
            flex-direction: column;
        }
        
        @media (min-width: 768px) {
            .main-content {
                flex-direction: row;
                height: calc(100vh - 150px);
            }
        }
        
        .player-section {
            flex: 2;
            padding: 15px;
            display: flex;
            flex-direction: column;
        }
        
        .playlist-section {
            flex: 1;
            padding: 15px;
            background-color: #252525;
            border-left: 1px solid #444;
            overflow-y: auto;
        }
        
        .video-container {
            width: 100%;
            background-color: #000;
            border-radius: 6px;
            overflow: hidden;
            flex-grow: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        #videoPlayer {
            width: 100%;
            height: 100%;
            max-height: 70vh;
            background-color: #000;
        }
        
        .controls {
            display: flex;
            gap: 8px;
            margin-top: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .controls button {
            padding: 10px 15px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }
        
        .controls button:hover {
            background-color: #2980b9;
        }
        
        .controls button:disabled {
            background-color: #555;
            cursor: not-allowed;
        }
        
        .upload-section {
            padding: 15px;
            margin-bottom: 15px;
            background-color: #252525;
            border-radius: 6px;
        }
        
        .url-input {
            display: flex;
            margin-top: 12px;
        }
        
        .url-input input {
            flex: 1;
            padding: 10px;
            border: 1px solid #444;
            border-radius: 4px 0 0 4px;
            font-size: 14px;
            background-color: #333;
            color: #fff;
        }
        
        .url-input button {
            padding: 10px 15px;
            background-color: #2ecc71;
            color: white;
            border: none;
            border-radius: 0 4px 4px 0;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .url-input button:hover {
            background-color: #27ae60;
        }
        
        .playlist {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #444;
            border-radius: 4px;
            background-color: #333;
        }
        
        .playlist-item {
            padding: 12px;
            border-bottom: 1px solid #444;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }
        
        .playlist-item:hover {
            background-color: #3d3d3d;
        }
        
        .playlist-item.active {
            background-color: #3498db;
            font-weight: bold;
        }
        
        .playlist-item:last-child {
            border-bottom: none;
        }
        
        .group-title {
            padding: 10px;
            background-color: #2c3e50;
            color: white;
            font-weight: bold;
            margin-top: 10px;
            border-radius: 4px;
        }
        
        .group-title:first-child {
            margin-top: 0;
        }
        
        .error {
            color: #e74c3c;
            margin-top: 10px;
            padding: 10px;
            background-color: #fbdfdc;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .hidden {
            display: none;
        }
        
        .now-playing {
            margin: 15px 0;
            padding: 12px;
            background-color: #2c3e50;
            border-radius: 4px;
            font-size: 14px;
            text-align: center;
        }
        
        .simple-button {
            display: block;
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            text-align: center;
            transition: background-color 0.2s;
        }
        
        .simple-button:hover {
            background-color: #2980b9;
        }
        
        .status {
            text-align: center;
            padding: 10px;
            font-size: 14px;
            color: #7f8c8d;
        }
        
        .loading {
            display: none;
            text-align: center;
            padding: 15px;
        }
        
        .loading-spinner {
            border: 4px solid #3498db;
            border-top: 4px solid transparent;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>M3U Видеоплеер</h1>
            <p>Поддержка HLS и других форматов видео</p>
        </header>
        
        <div class="main-content">
            <div class="player-section">
                <div class="upload-section">
                    <button class="simple-button" id="loadDefaultBtn">Загрузить тестовый плейлист</button>
                    
                    <div class="url-input">
                        <input type="text" id="urlInput" placeholder="Введите URL M3U плейлиста или прямую ссылку на видео">
                        <button id="loadUrlBtn">Загрузить</button>
                    </div>
                    
                    <div id="errorMessage" class="error hidden"></div>
                    <div class="loading" id="loadingIndicator">
                        <div class="loading-spinner"></div>
                        <p>Загрузка...</p>
                    </div>
                </div>
                
                <div class="now-playing hidden" id="nowPlaying">
                    Сейчас: <span id="currentTrackName">Название канала</span>
                </div>
                
                <div class="video-container">
                    <video id="videoPlayer" controls></video>
                </div>
                
                <div class="controls">
                    <button id="prevBtn" disabled>⏮ Назад</button>
                    <button id="nextBtn" disabled>Вперед ⏭</button>
                    <button id="fullscreenBtn">Полный экран</button>
                </div>
                
                <div class="status" id="playerStatus">
                    Ожидание загрузки плейлиста...
                </div>
            </div>
            
            <div class="playlist-section">
                <h2>Плейлист</h2>
                <div class="playlist" id="playlistContainer">
                    <p style="text-align: center; padding: 20px;">Загрузите M3U плейлист, чтобы увидеть список каналов</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Элементы DOM
            const urlInput = document.getElementById('urlInput');
            const loadUrlBtn = document.getElementById('loadUrlBtn');
            const loadDefaultBtn = document.getElementById('loadDefaultBtn');
            const videoPlayer = document.getElementById('videoPlayer');
            const playlistContainer = document.getElementById('playlistContainer');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const fullscreenBtn = document.getElementById('fullscreenBtn');
            const errorMessage = document.getElementById('errorMessage');
            const nowPlaying = document.getElementById('nowPlaying');
            const currentTrackName = document.getElementById('currentTrackName');
            const playerStatus = document.getElementById('playerStatus');
            const loadingIndicator = document.getElementById('loadingIndicator');
            
            let currentPlaylist = [];
            let currentTrackIndex = -1;
            let hls = null;
            
            // Пример плейлиста
            const examplePlaylist = `#EXTM3U
#EXTINF:-1 group-title="Каналы от Dmitry-tv",D-TV6
http://dmitry-tv.ddns.net:8666/his/CH_D-TV6
#EXTINF:-1 group-title="Каналы от Dmitry-tv",Dmitry-tv HD
http://dmitry-tv.ddns.net:8000/his/CH_DMITRY-TVHD
#EXTINF:-1 group-title="ЭФИРНЫЕ",Первый канал (+4)
http://dmi3y-tv.ru/hls/T2/CH_1TV_4.m3u8
#EXTINF:-1 group-title="ЭФИРНЫЕ",Россия 1
http://dmi3y-tv.ru/hls/smotrim/T2/CH_RUSSIA1.m3u8
#EXTINF:-1 group-title="ЭФИРНЫЕ",Россия 1 HD
http://dmi3y-tv.ru/hls/smotrim/T2/CH_RUSSIA1HD.m3u8
#EXTINF:-1 group-title="ЭФИРНЫЕ",Россия 1 HD (+2) (auto)
http://vgtrkregion-reg.cdnvideo.ru/vgtrk/2/russia1-hd/index.m3u8
#EXTINF:-1 group-title="ЭФИРНЫЕ",Россия 1 (+4)
http://dmi3y-tv.ru/hls/T2/CH_RUSSIA1_4.m3u8
#EXTINF:-1 group-title="ЭФИРНЫЕ",Россия 1 HD (+4) (auto)
http://vgtrkregion-reg.cdnvideo.ru/vgtrk/4/russia1-hd/index.m3u8`;
            
            // Обработчик загрузки примера плейлиста
            loadDefaultBtn.addEventListener('click', () => {
                parsePlaylist(examplePlaylist);
            });
            
            // Обработчик загрузки по URL
            loadUrlBtn.addEventListener('click', () => {
                const url = urlInput.value.trim();
                if (url) {
                    // Проверяем, является ли URL прямым видеофайлом
                    if (isDirectVideoUrl(url)) {
                        currentPlaylist = [{ 
                            title: 'Прямое видео', 
                            url: url,
                            group: 'Прямые ссылки'
                        }];
                        renderPlaylist({ 'Прямые ссылки': currentPlaylist });
                        playTrack(0);
                    } else {
                        loadPlaylistFromUrl(url);
                    }
                } else {
                    showError('Пожалуйста, введите URL M3U плейлиста или прямую ссылку на видео');
                }
            });
            
            // Обработчики кнопок навигации
            prevBtn.addEventListener('click', playPreviousTrack);
            nextBtn.addEventListener('click', playNextTrack);
            fullscreenBtn.addEventListener('click', toggleFullscreen);
            
            // Проверяем, является ли URL прямым видеофайлом
            function isDirectVideoUrl(url) {
                const videoExtensions = ['.mp4', '.webm', '.ogg', '.m3u8', '.ts', '.mov', '.avi', '.wmv', '.mkv'];
                return videoExtensions.some(ext => url.toLowerCase().includes(ext));
            }
            
            // Функция загрузки плейлиста по URL
            function loadPlaylistFromUrl(url) {
                hideError();
                showLoading();
                
                fetch(url)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`Ошибка HTTP: ${response.status}`);
                        }
                        return response.text();
                    })
                    .then(data => {
                        hideLoading();
                        parsePlaylist(data);
                    })
                    .catch(error => {
                        hideLoading();
                        showError(`Не удалось загрузить плейлист: ${error.message}`);
                    });
            }
            
            // Функция парсинга M3U плейлиста
            function parsePlaylist(content) {
                hideError();
                
                try {
                    const lines = content.split('\n');
                    const groups = {};
                    let currentGroup = "Без группы";
                    
                    for (let i = 0; i < lines.length; i++) {
                        const line = lines[i].trim();
                        
                        if (line.startsWith('#EXTINF:')) {
                            // Извлекаем информацию о канале
                            const groupMatch = line.match(/group-title="([^"]*)"/);
                            const titleMatch = line.match(/,(.*)$/);
                            
                            if (groupMatch) {
                                currentGroup = groupMatch[1];
                            }
                            
                            const title = titleMatch ? titleMatch[1].trim() : 'Без названия';
                            const urlLine = lines[++i] ? lines[i].trim() : '';
                            
                            if (urlLine && !urlLine.startsWith('#')) {
                                if (!groups[currentGroup]) {
                                    groups[currentGroup] = [];
                                }
                                
                                groups[currentGroup].push({
                                    title: title,
                                    url: urlLine,
                                    group: currentGroup
                                });
                            }
                        }
                    }
                    
                    // Преобразуем группы в плоский список для воспроизведения
                    currentPlaylist = [];
                    for (const group in groups) {
                        currentPlaylist = currentPlaylist.concat(groups[group]);
                    }
                    
                    if (currentPlaylist.length === 0) {
                        showError('Не удалось найти каналы в плейлисте');
                        return;
                    }
                    
                    renderPlaylist(groups);
                    playTrack(0);
                    playerStatus.textContent = `Загружено каналов: ${currentPlaylist.length}`;
                } catch (error) {
                    showError(`Ошибка при разборе плейлиста: ${error.message}`);
                }
            }
            
            // Функция отображения плейлиста с группировкой
            function renderPlaylist(groups) {
                playlistContainer.innerHTML = '';
                
                if (Object.keys(groups).length === 0) {
                    playlistContainer.innerHTML = '<p>Плейлист пуст</p>';
                    return;
                }
                
                for (const group in groups) {
                    const groupElement = document.createElement('div');
                    groupElement.className = 'group-title';
                    groupElement.textContent = group;
                    playlistContainer.appendChild(groupElement);
                    
                    groups[group].forEach((channel, index) => {
                        const globalIndex = currentPlaylist.findIndex(c => c.url === channel.url);
                        
                        const item = document.createElement('div');
                        item.className = 'playlist-item';
                        if (globalIndex === currentTrackIndex) {
                            item.classList.add('active');
                        }
                        
                        item.textContent = channel.title;
                        item.addEventListener('click', () => playTrack(globalIndex));
                        
                        playlistContainer.appendChild(item);
                    });
                }
                
                // Активируем кнопки навигации
                prevBtn.disabled = currentPlaylist.length <= 1;
                nextBtn.disabled = currentPlaylist.length <= 1;
            }
            
            // Функция воспроизведения трека
            function playTrack(index) {
                if (index < 0 || index >= currentPlaylist.length) {
                    return;
                }
                
                const track = currentPlaylist[index];
                currentTrackIndex = index;
                
                // Останавливаем предыдущее воспроизведение
                if (hls) {
                    hls.destroy();
                    hls = null;
                }
                
                videoPlayer.src = '';
                showLoading();
                
                // Показываем информацию о текущем треке
                currentTrackName.textContent = track.title;
                nowPlaying.classList.remove('hidden');
                
                // Обновляем выделение в плейлисте
                const items = playlistContainer.querySelectorAll('.playlist-item');
                items.forEach((item, i) => {
                    const globalIndex = currentPlaylist.findIndex(c => c.title === item.textContent);
                    if (globalIndex === index) {
                        item.classList.add('active');
                    } else {
                        item.classList.remove('active');
                    }
                });
                
                // Проверяем, является ли источник HLS
                if (track.url.includes('.m3u8')) {
                    if (Hls.isSupported()) {
                        hls = new Hls();
                        hls.loadSource(track.url);
                        hls.attachMedia(videoPlayer);
                        hls.on(Hls.Events.MANIFEST_PARSED, function() {
                            hideLoading();
                            videoPlayer.play().catch(error => {
                                showError('Не удалось автоматически воспроизвести видео: ' + error.message);
                            });
                        });
                        hls.on(Hls.Events.ERROR, function(event, data) {
                            if (data.fatal) {
                                switch(data.type) {
                                    case Hls.ErrorTypes.NETWORK_ERROR:
                                        showError('Ошибка сети: ' + data.details);
                                        break;
                                    case Hls.ErrorTypes.MEDIA_ERROR:
                                        showError('Ошибка медиа: ' + data.details);
                                        break;
                                    default:
                                        showError('Неизвестная ошибка: ' + data.details);
                                        break;
                                }
                            }
                        });
                    } else if (videoPlayer.canPlayType('application/vnd.apple.mpegurl')) {
                        // Поддержка HLS в Safari
                        videoPlayer.src = track.url;
                        videoPlayer.addEventListener('loadedmetadata', function() {
                            hideLoading();
                            videoPlayer.play().catch(error => {
                                showError('Не удалось автоматически воспроизвести видео: ' + error.message);
                            });
                        });
                    } else {
                        showError('Ваш браузер не поддерживает воспроизведение HLS-потоков');
                    }
                } else {
                    // Прямое видео (MP4, WebM и т.д.)
                    videoPlayer.src = track.url;
                    videoPlayer.addEventListener('loadeddata', function() {
                        hideLoading();
                        videoPlayer.play().catch(error => {
                            showError('Не удалось автоматически воспроизвести видео: ' + error.message);
                        });
                    });
                    videoPlayer.addEventListener('error', function() {
                        hideLoading();
                        showError('Ошибка загрузки видео. Возможно, неподдерживаемый формат или проблемы с сетью.');
                    });
                }
            }
            
            // Функция воспроизведения следующего трека
            function playNextTrack() {
                if (currentPlaylist.length === 0) return;
                
                let nextIndex = currentTrackIndex + 1;
                if (nextIndex >= currentPlaylist.length) {
                    nextIndex = 0;
                }
                
                playTrack(nextIndex);
            }
            
            // Функция воспроизведения предыдущего трека
            function playPreviousTrack() {
                if (currentPlaylist.length === 0) return;
                
                let prevIndex = currentTrackIndex - 1;
                if (prevIndex < 0) {
                    prevIndex = currentPlaylist.length - 1;
                }
                
                playTrack(prevIndex);
            }
            
            // Функция переключения полноэкранного режима
            function toggleFullscreen() {
                if (videoPlayer.requestFullscreen) {
                    videoPlayer.requestFullscreen();
                } else if (videoPlayer.webkitRequestFullscreen) {
                    videoPlayer.webkitRequestFullscreen();
                } else if (videoPlayer.msRequestFullscreen) {
                    videoPlayer.msRequestFullscreen();
                }
            }
            
            // Функция показа ошибки
            function showError(message) {
                errorMessage.textContent = message;
                errorMessage.classList.remove('hidden');
                playerStatus.textContent = 'Ошибка: ' + message;
            }
            
            // Функция скрытия ошибки
            function hideError() {
                errorMessage.classList.add('hidden');
            }
            
            // Показать индикатор загрузки
            function showLoading() {
                loadingIndicator.style.display = 'block';
            }
            
            // Скрыть индикатор загрузки
            function hideLoading() {
                loadingIndicator.style.display = 'none';
            }
            
            // Автоматическое воспроизведение следующего видео при завершении текущего
            videoPlayer.addEventListener('ended', playNextTrack);
        });
    </script>
</body>
</html>
