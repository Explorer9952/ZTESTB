<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M3U Видеоплеер</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f0f0f0;
            padding: 10px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: #fff;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        header {
            padding: 15px;
            background-color: #2c3e50;
            color: white;
            text-align: center;
        }
        
        h1 {
            font-size: 1.5rem;
            margin-bottom: 5px;
        }
        
        .main-content {
            display: flex;
            flex-direction: column;
        }
        
        @media (min-width: 768px) {
            .main-content {
                flex-direction: row;
            }
        }
        
        .player-section {
            flex: 2;
            padding: 10px;
        }
        
        .playlist-section {
            flex: 1;
            padding: 10px;
            background-color: #f8f9fa;
            border-left: 1px solid #ddd;
        }
        
        .video-container {
            width: 100%;
            background-color: #000;
        }
        
        #videoPlayer {
            width: 100%;
            height: auto;
            max-height: 70vh;
            background-color: #000;
        }
        
        .controls {
            display: flex;
            gap: 5px;
            margin-top: 10px;
            justify-content: center;
        }
        
        .controls button {
            padding: 8px 12px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .controls button:hover {
            background-color: #2980b9;
        }
        
        .controls button:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }
        
        .upload-section {
            padding: 10px;
            margin-bottom: 10px;
            background-color: #e8f4fc;
            border-radius: 5px;
        }
        
        .url-input {
            display: flex;
            margin-top: 10px;
        }
        
        .url-input input {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 3px 0 0 3px;
            font-size: 14px;
        }
        
        .url-input button {
            padding: 8px 12px;
            background-color: #2ecc71;
            color: white;
            border: none;
            border-radius: 0 3px 3px 0;
            cursor: pointer;
        }
        
        .url-input button:hover {
            background-color: #27ae60;
        }
        
        .playlist {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 3px;
            background-color: white;
        }
        
        .playlist-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            font-size: 14px;
        }
        
        .playlist-item:hover {
            background-color: #e3f2fd;
        }
        
        .playlist-item.active {
            background-color: #bbdefb;
            font-weight: bold;
        }
        
        .playlist-item:last-child {
            border-bottom: none;
        }
        
        .group-title {
            padding: 8px;
            background-color: #2c3e50;
            color: white;
            font-weight: bold;
            margin-top: 10px;
        }
        
        .group-title:first-child {
            margin-top: 0;
        }
        
        .error {
            color: #e74c3c;
            margin-top: 10px;
            padding: 8px;
            background-color: #fadbd8;
            border-radius: 3px;
            font-size: 14px;
        }
        
        .hidden {
            display: none;
        }
        
        .now-playing {
            margin: 10px 0;
            padding: 8px;
            background-color: #ffeebc;
            border-radius: 3px;
            font-size: 14px;
            text-align: center;
        }
        
        .simple-button {
            display: block;
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            text-align: center;
        }
        
        .simple-button:hover {
            background-color: #2980b9;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>M3U Видеоплеер</h1>
            <p>Простой плеер для M3U плейлистов</p>
        </header>
        
        <div class="main-content">
            <div class="player-section">
                <div class="upload-section">
                    <button class="simple-button" id="loadDefaultBtn">Загрузить пример плейлиста</button>
                    
                    <div class="url-input">
                        <input type="text" id="urlInput" placeholder="Введите URL M3U плейлиста">
                        <button id="loadUrlBtn">Загрузить</button>
                    </div>
                    
                    <div id="errorMessage" class="error hidden"></div>
                </div>
                
                <div class="now-playing hidden" id="nowPlaying">
                    Сейчас: <span id="currentTrackName">Название канала</span>
                </div>
                
                <div class="video-container">
                    <video id="videoPlayer" controls></video>
                </div>
                
                <div class="controls">
                    <button id="prevBtn" disabled>⏮ Назад</button>
                    <button id="nextBtn" disabled>Вперед ⏭</button>
                </div>
            </div>
            
            <div class="playlist-section">
                <h2>Плейлист</h2>
                <div class="playlist" id="playlistContainer">
                    <p style="text-align: center; padding: 20px;">Загрузите M3U плейлист, чтобы увидеть список каналов</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Элементы DOM
            const urlInput = document.getElementById('urlInput');
            const loadUrlBtn = document.getElementById('loadUrlBtn');
            const loadDefaultBtn = document.getElementById('loadDefaultBtn');
            const videoPlayer = document.getElementById('videoPlayer');
            const playlistContainer = document.getElementById('playlistContainer');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const errorMessage = document.getElementById('errorMessage');
            const nowPlaying = document.getElementById('nowPlaying');
            const currentTrackName = document.getElementById('currentTrackName');
            
            let currentPlaylist = [];
            let currentTrackIndex = -1;
            
            // Пример плейлиста из вашего описания
            const examplePlaylist = `#EXTM3U
#EXTINF:-1 group-title="Каналы от Dmitry-tv",D-TV6
http://dmitry-tv.ddns.net:8666/his/CH_D-TV6
#EXTINF:-1 group-title="Каналы от Dmitry-tv",Dmitry-tv HD
http://dmitry-tv.ddns.net:8000/his/CH_DMITRY-TVHD
#EXTINF:-1 group-title="ЭФИРНЫЕ",Первый канал (+4)
http://dmi3y-tv.ru/hls/T2/CH_1TV_4.m3u8
#EXTINF:-1 group-title="ЭФИРНЫЕ",Россия 1
http://dmi3y-tv.ru/hls/smotrim/T2/CH_RUSSIA1.m3u8
#EXTINF:-1 group-title="ЭФИРНЫЕ",Россия 1 HD
http://dmi3y-tv.ru/hls/smotrim/T2/CH_RUSSIA1HD.m3u8
#EXTINF:-1 group-title="ЭФИРНЫЕ",Россия 1 HD (+2) (auto)
http://vgtrkregion-reg.cdnvideo.ru/vgtrk/2/russia1-hd/index.m3u8
#EXTINF:-1 group-title="ЭФИРНЫЕ",Россия 1 (+4)
http://dmi3y-tv.ru/hls/T2/CH_RUSSIA1_4.m3u8
#EXTINF:-1 group-title="ЭФИРНЫЕ",Россия 1 HD (+4) (auto)
http://vgtrkregion-reg.cdnvideo.ru/vgtrk/4/russia1-hd/index.m3u8`;
            
            // Обработчик загрузки примера плейлиста
            loadDefaultBtn.addEventListener('click', () => {
                parsePlaylist(examplePlaylist);
            });
            
            // Обработчик загрузки по URL
            loadUrlBtn.addEventListener('click', () => {
                const url = urlInput.value.trim();
                if (url) {
                    loadPlaylistFromUrl(url);
                } else {
                    showError('Пожалуйста, введите URL M3U плейлиста');
                }
            });
            
            // Обработчики кнопок навигации
            prevBtn.addEventListener('click', playPreviousTrack);
            nextBtn.addEventListener('click', playNextTrack);
            
            // Функция загрузки плейлиста по URL
            function loadPlaylistFromUrl(url) {
                hideError();
                
                fetch(url)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`Ошибка HTTP: ${response.status}`);
                        }
                        return response.text();
                    })
                    .then(data => parsePlaylist(data))
                    .catch(error => {
                        showError(`Не удалось загрузить плейлист: ${error.message}`);
                    });
            }
            
            // Функция парсинга M3U плейлиста
            function parsePlaylist(content) {
                hideError();
                
                try {
                    const lines = content.split('\n');
                    const groups = {};
                    let currentGroup = "Без группы";
                    
                    for (let i = 0; i < lines.length; i++) {
                        const line = lines[i].trim();
                        
                        if (line.startsWith('#EXTINF:')) {
                            // Извлекаем информацию о канале
                            const groupMatch = line.match(/group-title="([^"]*)"/);
                            const titleMatch = line.match(/,(.*)$/);
                            
                            if (groupMatch) {
                                currentGroup = groupMatch[1];
                            }
                            
                            const title = titleMatch ? titleMatch[1].trim() : 'Без названия';
                            const urlLine = lines[++i] ? lines[i].trim() : '';
                            
                            if (urlLine && !urlLine.startsWith('#')) {
                                if (!groups[currentGroup]) {
                                    groups[currentGroup] = [];
                                }
                                
                                groups[currentGroup].push({
                                    title: title,
                                    url: urlLine,
                                    group: currentGroup
                                });
                            }
                        }
                    }
                    
                    // Преобразуем группы в плоский список для воспроизведения
                    currentPlaylist = [];
                    for (const group in groups) {
                        currentPlaylist = currentPlaylist.concat(groups[group]);
                    }
                    
                    if (currentPlaylist.length === 0) {
                        showError('Не удалось найти каналы в плейлисте');
                        return;
                    }
                    
                    renderPlaylist(groups);
                    playTrack(0);
                } catch (error) {
                    showError(`Ошибка при разборе плейлиста: ${error.message}`);
                }
            }
            
            // Функция отображения плейлиста с группировкой
            function renderPlaylist(groups) {
                playlistContainer.innerHTML = '';
                
                if (Object.keys(groups).length === 0) {
                    playlistContainer.innerHTML = '<p>Плейлист пуст</p>';
                    return;
                }
                
                for (const group in groups) {
                    const groupElement = document.createElement('div');
                    groupElement.className = 'group-title';
                    groupElement.textContent = group;
                    playlistContainer.appendChild(groupElement);
                    
                    groups[group].forEach((channel, index) => {
                        const globalIndex = currentPlaylist.findIndex(c => c.url === channel.url);
                        
                        const item = document.createElement('div');
                        item.className = 'playlist-item';
                        if (globalIndex === currentTrackIndex) {
                            item.classList.add('active');
                        }
                        
                        item.textContent = channel.title;
                        item.addEventListener('click', () => playTrack(globalIndex));
                        
                        playlistContainer.appendChild(item);
                    });
                }
                
                // Активируем кнопки навигации
                prevBtn.disabled = currentPlaylist.length <= 1;
                nextBtn.disabled = currentPlaylist.length <= 1;
            }
            
            // Функция воспроизведения трека
            function playTrack(index) {
                if (index < 0 || index >= currentPlaylist.length) {
                    return;
                }
                
                const track = currentPlaylist[index];
                currentTrackIndex = index;
                
                // Останавливаем предыдущее воспроизведение
                videoPlayer.src = '';
                
                // Пытаемся установить новый источник
                try {
                    videoPlayer.src = track.url;
                    videoPlayer.load();
                    
                    // Показываем информацию о текущем треке
                    currentTrackName.textContent = track.title;
                    nowPlaying.classList.remove('hidden');
                    
                    // Обновляем выделение в плейлисте
                    const items = playlistContainer.querySelectorAll('.playlist-item');
                    items.forEach((item, i) => {
                        if (i === index) {
                            item.classList.add('active');
                        } else {
                            item.classList.remove('active');
                        }
                    });
                    
                    // Пытаемся воспроизвести
                    videoPlayer.play().catch(error => {
                        showError('Не удалось воспроизвести видео: ' + error.message);
                    });
                } catch (error) {
                    showError('Ошибка при загрузке видео: ' + error.message);
                }
            }
            
            // Функция воспроизведения следующего трека
            function playNextTrack() {
                if (currentPlaylist.length === 0) return;
                
                let nextIndex = currentTrackIndex + 1;
                if (nextIndex >= currentPlaylist.length) {
                    nextIndex = 0;
                }
                
                playTrack(nextIndex);
            }
            
            // Функция воспроизведения предыдущего трека
            function playPreviousTrack() {
                if (currentPlaylist.length === 0) return;
                
                let prevIndex = currentTrackIndex - 1;
                if (prevIndex < 0) {
                    prevIndex = currentPlaylist.length - 1;
                }
                
                playTrack(prevIndex);
            }
            
            // Функция показа ошибки
            function showError(message) {
                errorMessage.textContent = message;
                errorMessage.classList.remove('hidden');
            }
            
            // Функция скрытия ошибки
            function hideError() {
                errorMessage.classList.add('hidden');
            }
            
            // Автоматическое воспроизведение следующего видео при завершении текущего
            videoPlayer.addEventListener('ended', playNextTrack);
        });
    </script>
</body>
</html>
